function selectFileImage(f){var c=0;if(!$(".pop_img")[0]){var o='<div class="pop_img">';o+='<img id="avatar" />';o+='<div class="rectbox"><div class="circlebox">图片加载中。。。</div></div><div class="btnbox"><span class="close">取消</span><span class="ok">使用照片</span></div></div>';$("body").append(o)}else{$(".pop_img").show().find(".circlebox").html("图片加载中。。。")}c=$(window).scrollTop();$("body").addClass("modal-open").css("top",-c+"px");var q=270;var n=330;var g=($(window).width()-q)/2;var r=($(window).height()-$(".pop_img .btnbox").height()-n)/2;$(".pop_img .rectbox").css({width:270,height:330,top:r,left:"50%",marginLeft:-135}).find(".circlebox").css({height:q,"line-height":q+"px"});var m={};m.swidth=q;m.sheight=n;var e=f;rFilter=/^(?:image\/bmp|image\/cis\-cod|image\/gif|image\/ief|image\/jpeg|image\/jpeg|image\/jpeg|image\/gif|image\/pipeg|image\/png|image\/svg\+xml|image\/tiff|image\/x\-cmu\-raster|image\/x\-cmx|image\/x\-icon|image\/x\-portable\-anymap|image\/x\-portable\-bitmap|image\/x\-portable\-graymap|image\/x\-portable\-pixmap|image\/x\-rgb|image\/x\-xbitmap|image\/x\-xpixmap|image\/x\-xwindowdump)$/i;if(!rFilter.test(e.type)){close(c);var k=[["请上传正确的图片（jpg、gif、png）!","warn"]];var j=["确定"];pop.ini(k,j);return}if(e){var p=1;EXIF.getData(e,function(){EXIF.getAllTags(this);p=EXIF.getTag(this,"Orientation")});var a=new FileReader();a.onload=function(){var h=new Image();h.src=this.result;h.addEventListener("load",function(){var u=this.naturalWidth;var w=this.naturalHeight;var x=1;if(p!=""&&p>3){u=this.naturalHeight;w=this.naturalWidth}if((u<w)&&(u/w)<(9/11)){x=q/u;w=w*x;u=q}else{x=n/w;u=u*x;w=n}var v=document.createElement("canvas");var t=v.getContext("2d");v.width=u;v.height=w;t.clearRect(0,0,v.width,v.height);if(p!=""&&p>1){switch(p){case 3:t.rotate(Math.PI);t.drawImage(this,-u,-w,u,w);break;case 6:t.rotate(Math.PI/2);t.drawImage(this,0,-u,w,u);break;case 8:t.rotate(Math.PI*3/2);t.drawImage(this,-w,0,w,u);break}}else{t.drawImage(this,0,0,u,w)}var s=v.toDataURL("image/png");var y=($(window).height()-$(".pop_img .btnbox").height()-w)/2;var l=($(window).width()-u)/2;$(".pop_img .circlebox").html("");$("#avatar").attr("src",s).css({top:y,left:l});m.url=s;m.srcX=g-l;m.srcY=r-y});$(h).error(function(){close(c);var s=[["请上传正确的图片","warn"]];var l=["确定"];pop.ini(s,l)})};a.readAsDataURL(e);function i(h){return Math.sqrt(1-Math.pow(h-1,2))}var b=document.getElementById("avatar");Transform(b);var d=1;new AlloyFinger(b,{multipointStart:function(h){To.stopAll();d=b.scaleX},pinch:function(h){var l=h.zoom;if(d*l>300){this.touchEnd();return}b.scaleX=b.scaleY=d*l},multipointEnd:function(){To.stopAll();var s=b.width;var t=b.height;var v=s*b.scaleX;var l=t*b.scaleY;if(v<q){new To(b,"scaleX",q/s,500);new To(b,"scaleY",q/s,500);b.scaleX=b.scaleY=q/s;if(t*q/s<n){new To(b,"scaleX",n/t,500);new To(b,"scaleY",n/t,500);b.scaleX=b.scaleY=n/t}}if(l<n){new To(b,"scaleX",n/t,500);new To(b,"scaleY",n/t,500);b.scaleX=b.scaleY=n/t;if(s*n/t<q){new To(b,"scaleX",q/s,500);new To(b,"scaleY",q/s,500);b.scaleX=b.scaleY=q/s}}if(b.scaleX<1){new To(b,"scaleX",1,500,i);new To(b,"scaleY",1,500,i);b.scaleX=b.scaleY=1}var u=b.getBoundingClientRect();var h=u.top;var w=u.left;if(r<u.top){h=r;new To(b,"translateY",r+(b.scaleY-1)*t/2,500,i);$(b).css({top:0})}if((r+n)>u.bottom){h=r;new To(b,"translateY",r+n-(b.scaleY+1)*t/2,500,i);$(b).css({top:0})}if(g<u.left){w=g;new To(b,"translateX",g+(b.scaleX-1)*s/2,500,i);$(b).css({left:0})}if((g+q)>u.right){w=g;new To(b,"translateX",g+q-(b.scaleX+1)*s/2,500,i);$(b).css({left:0})}m.srcY=(r-h)/b.scaleY;m.srcX=(g-w)/b.scaleX;m.swidth=q/b.scaleY;m.sheight=n/b.scaleX},pressMove:function(h){b.translateX+=h.deltaX;b.translateY+=h.deltaY;h.preventDefault()}})}$(".close").one("click",function(){close(c)});$(".ok").unbind("click");$(".ok").one("click",function(t){close(c);pop.load("正在上传");var s=crop(m);var l=s.substr(s.indexOf(",")+1);var u={photo:l,userid:$("#rsmid").val()};var h=$.ajax({url:$_CONFIG.domain+"/ajax/my/uploadpic.ajax.php",asyn:false,dataType:"json",type:"post",data:u,success:function(v){if(v.status==1){pop.msg("你的照片上传成功!");$(".sbox .user .upimg img").attr("src","data:image/jpg;base64,"+v.photo)}else{if(v.status==0&&v.url){location.href=v.url;return false}pop.close();var x=[[v.message,"warn"]];var w=["确定"];pop.ini(x,w);return false}pop.close()},error:function(v,x,w){pop.close()}})})}function close(a){$("body").removeClass("modal-open").css("top","");$(window).scrollTop(a);$("#avatar").attr("src","").css("transform","");$(".pop_img").hide();$("#file").val("")}function crop(e,h){var g=e||{};var f=1;var d=document.createElement("canvas"),b=d.getContext("2d");b.clearRect(0,0,100,1000);d.width=g.swidth*f;d.height=g.sheight*f;var a=new Image();a.setAttribute("src",g.url);b.drawImage(a,g.srcX,g.srcY,g.swidth,g.sheight,0,0,g.swidth*f,g.sheight*f);return d.toDataURL("image/png")};